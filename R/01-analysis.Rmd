---
params:
  static: FALSE
title: "My IMDb Ratings Analysis"
author: "MickaÃ«l Canouil, *Ph.D.*"
date: '`r format(Sys.time(), "%B %d, %Y")`'
knit: (function(inputFile, encoding) rmarkdown::render(inputFile, output_file = "index.html", encoding = encoding, output_dir = here::here("docs"), intermediates_dir = here::here("docs")))
output: 
  bookdown::html_document2: 
    theme: simplex
    toc: true
    toc_depth: 3
    toc_float: 
      collapsed: true
    fig_width: 6.3
    fig_height:  4.7
    number_sections: true
    self_contained: true
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: cerulean
    social: [ "twitter", "facebook" ]
    source_code: "https://github.com/mcanouil/IMDbRating"
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
### Load packages ==================================================================================
library(here)

suppressPackageStartupMessages({
  library(knitr)
  library(ggplot2)
  library(ggtext)
  library(xml2)
  library(rvest)
  library(lubridate)
  library(data.table)
})


### Environment ====================================================================================
opts_chunk$set(
  comment = "#>",
  results = "asis",
  include = TRUE,
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  dpi = 120,
  tidy = FALSE,
  crop = TRUE,
  autodep = TRUE,
  fig.align = "center",
  fig.path = here("images", "fig-")
)


### Source functions ===============================================================================
get_metascore <- function(x) { 
  sapply(
    X = paste0("https://www.imdb.com/title/", x, "/"), 
    FUN = function(y) {
      as.numeric(rvest::html_text(
        x = rvest::html_node(
          x = xml2::read_html(x = paste0(y, "criticreviews")), 
          css = "div.metascore"
        )              
      )) / 10
    }
  )
}

source(here("R/theme_black.R"))


### Define theme ===================================================================================
options(
  ggplot2.discrete.colour = function(...) scale_colour_viridis_d(..., begin = 0.15, end = 0.85),
  ggplot2.discrete.fill = function(...) scale_fill_viridis_d(..., begin = 0.15, end = 0.85),
  ggplot2.continuous.colour = function(...) scale_colour_viridis_c(..., begin = 0.15, end = 0.85),
  ggplot2.continuous.fill = function(...) scale_fill_viridis_c(..., begin = 0.15, end = 0.85)
)
theme_set(
  theme_black(11, base_family = "xkcd") +
    theme(
      plot.title.position = "plot",
      plot.caption.position = "plot",
      plot.title = element_markdown(),
      plot.subtitle = element_markdown(face = "italic", size = rel(0.8)),
      plot.caption = element_markdown(face = "italic", size = rel(0.5)),
      axis.title.x = element_markdown(),
      axis.text.x = element_markdown(),
      axis.title.y = element_markdown(),
      axis.text.y = element_markdown()
    )
)

fig_caption <- "&copy; Micka&euml;l '<i style='color:#21908CFF;'>Coeos</i>' Canouil"
```

```{r import-data}
movies_db <- fread(file = here("data", "theatres.csv"))[,
  c("date", "month", "year") := list(
    as.IDate(date_time)
    as.character(month(as.IDate(date_time), label = TRUE, abbr = FALSE)),
    year(as.IDate(date_time))
  )
]

ratings_db <- fread(file = here("data", "ratings.csv"), encoding = "Latin-1")
setnames(ratings_db, names(ratings_db), gsub("[()]", "", gsub(" ", "_", tolower(names(ratings_db)))))
ratings_db[, 
  c("date_rated", "release_date") := lapply(.SD, as.IDate), 
  .SDcols = c("date_rated", "release_date")
][, 
  c("month_rated", "year_rated") := list(
    month(date_rated, label = TRUE, abbr = FALSE),
    year(date_rated)
  )
]

if (file.exists(here("data", "ratings_ms.csv"))) {
  ratings_db_ms <- fread(file = here("data", "ratings_ms.csv"))[, 
    c("date_rated", "release_date") := lapply(.SD, as.IDate), 
    .SDcols = c("date_rated", "release_date")
  ][date_rated < (today() - 100) | year < year(today())]
  
  ratings_db_new <- ratings_db[
    !const %in% ratings_db_ms[["const"]]
  ][, metascore_rating := get_metascore(const)]
  
  fwrite(x = rbind(ratings_db_ms, ratings_db_new), file = here("data", "ratings_ms.csv"))
} else {
  fwrite(x = ratings_db[, metascore_rating := get_metascore(const)][], file = here("data", "ratings_ms.csv"))
}

ratings_ms <- fread(file = here("data", "ratings_ms.csv"))[, 
  c("date_rated", "release_date") := lapply(.SD, as.IDate), 
  .SDcols = c("date_rated", "release_date")
][, in_theatres := as.integer(const %in% movies_db[["imdb_id"]])]
```

# Streak of Movies Seen in Theatres {.tabset}

## Per Year {-}

```{r streak-year, fig.width = 16 / 2.54, fig.height = 24.7 / 2.54}
streak_data <- movies_db %>% 
  mutate(date = date(date_time)) %>% 
  complete(date = full_seq(c(date, today()), 1)) %>% 
  group_by(date) %>% 
  summarise(count = sum(!is.na(theatre)), .groups = "drop") %>% 
  mutate(
    year = year(date),
    month = month(date, label = TRUE, abbr = FALSE),
    month_num = month(date),
    wday = wday(date, label = TRUE, abbr = FALSE, week_start = 1),
    count2 = ifelse(count == 0, NA, count)
  ) %>% 
  group_by(year) %>% 
  mutate(
    week = isoweek(date),
    week = ifelse(week == 1 & month_num == 12, max(week) + 1, week)
  ) %>% 
  ungroup() %>% 
  mutate(week = factor(sprintf("%02d", week), ordered = TRUE))

week_month_breaks <- streak_data %>% 
  filter(year > 2013) %>% 
  group_by(month) %>% 
  filter(wday == "Monday") %>% 
  add_count(week) %>% 
  distinct(month, week, n) %>% 
  filter(n == max(n)) %>% 
  filter(as.numeric(week) == min(as.numeric(week))) %>% 
  arrange(month, week) %>% 
  ungroup()

p <- ggplot(data = streak_data, mapping = aes(x = week, y = fct_rev(wday))) +
  geom_tile(
    data = ~ filter(.x, month_num %% 2 == 0),
    show.legend = FALSE,
    colour = "white",
    fill = "white",
    alpha = 0
  ) +
  geom_tile(
    data = ~ filter(.x, month_num %% 2 == 1),
    show.legend = FALSE,
    colour = "white",
    fill = "white",
    alpha = 0.2
  ) +
  geom_tile(aes(fill = count), alpha = 0.3) +
  geom_tile(
    data = ~ filter(.x, between(date, ymd("2020-03-16"), ymd("2020-06-21"))),
    fill = "#21908CFF", 
    alpha = 0.3
  ) +
  geom_text(aes(label = count2), colour = "white", na.rm = TRUE, family = "xkcd", size = 2.5) +
  scale_x_discrete(
    expand = expansion(c(0, 0)), 
    breaks = week_month_breaks[["week"]],
    labels = week_month_breaks[["month"]], 
    guide = guide_axis(n.dodge = 2)
  ) +
  scale_y_discrete(expand = expansion(c(0, 0))) +
  scale_colour_viridis_c() +
  scale_fill_viridis_c() +
  facet_grid(rows = vars(year)) +
  theme(
    panel.grid = element_blank(), 
    legend.position = "none"
  ) +
  labs(
    title = glue("Streak of Movies Seen in Theatres ({sum(streak_data$count)})"),
    caption = fig_caption,
    colour = "Count",
    fill = "Count",
    x = NULL, # "Week Number",
    y = NULL # "Day"
  )

p
```

## It Happened on Tuesdays {-}

```{r streak-year-tuesday, fig.width = 16 / 2.54, fig.height = 24.7 / 2.54}
ftest <- movies_db %>% 
  mutate(wday = wday(date(date_time), label = TRUE, abbr = FALSE, week_start = 1)) %>% 
  filter(between(year, 2014, 2019)) %>% 
  mutate(is_tuesday = ifelse(wday=="Tuesday", "Tuesday", "Other Days")) %>% 
  count(year, is_tuesday) %>% 
  mutate(is_2019 = ifelse(year==2019, "2019", "2014-2018")) %>% 
  group_by(is_2019, is_tuesday) %>% 
  summarise(n = mean(n), .groups = "drop") %>% 
  mutate(n = ceiling(n)) %>% 
  pivot_wider(names_from = "is_tuesday", values_from = "n") %>% 
  column_to_rownames("is_2019") %>% 
  fisher.test() %>% 
  tidy() %>% 
  mutate_if(is.numeric, signif, digits = 3) %>% 
  glue_data(
    "<i style='color:#21908CFF;'>2019's Tuesdays</i> <i>Vs.</i> <i style='color:#21908CFF;'>2014-2018's Tuesdays</i>: ",
    "<span style='color:firebrick2;'>OR = {estimate}</span>; ",
    "95% CI, {conf.low}-{conf.high}; <span style='color:firebrick2;'>P = {p.value}</span>",
    "<br>(<i>{method}</i>)"
  )
p +
  labs(subtitle = ftest) + 
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = 5.5, fill = "grey20", alpha = 0.5) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 6.5, ymax = Inf, fill = "grey20", alpha = 0.5) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 5.5, ymax = 6.5, colour = "firebrick2", fill = "transparent") +
  scale_y_discrete(
    expand = expansion(c(0, 0)),
    labels = function(x) ifelse(x == "Tuesday", "<span style='color:firebrick2;'>Tuesday</span>", x)
  ) +
  theme(axis.text.y = element_markdown(size = rel(0.8)))
```

# In One Day

```{r streak-day}
movies_db %>% 
  add_count(year, date(date_time)) %>% 
  filter(n == max(n)) %>% 
  mutate(
    wday = wday(date(date_time), label = TRUE, abbr = FALSE, week_start = 1),
    day = day(date(date_time)),
    month = month(date(date_time), label = TRUE, abbr = FALSE),
    nth = case_when(
      day %in% c(1, 21, 31) ~ "st",
      day %in% c(2, 22) ~ "nd",
      day %in% c(3, 23) ~ "rd",
      TRUE ~ "th"
    ),
    time = glue("{hour(date_time)}h{minute(date_time)}"),
    date = glue("{wday}, the {day}{nth} of {month}, {year(date(date_time))}"),
    theatre = glue("UGC {theatre}")
  ) %>% 
  select(date, theatre, time, room) %>% 
  gt(auto_align = "center") %>% 
  opt_all_caps(all_caps = TRUE) %>% 
  opt_row_striping()
```

# Ratings

```{r ratings}
who_colours <- setNames(viridis_pal(begin = 0.5, direction = -1)(3), c("COEOS", "METASCORE", "IMDB USERS"))
text_legend <- glue_collapse(
  glue("<b style='color:{who_colours};'>{names(who_colours)}</b>"), 
  sep = ", ", 
  last = " and "
)
p_ratings <- ggplot(
  data = pivot_longer(
    data = ratings_ms, 
    cols = ends_with("rating"), 
    names_to = "who", 
    names_pattern = "(.*)_.*", 
    names_transform = list(
      who = ~ factor(
        x = toupper(gsub("your", "coeos", .x)), 
        levels = c("COEOS", "METASCORE", "IMDB"),
        labels = 1:3
      )
    ),
    values_to = "rating"
  ),
  mapping = aes(
    x = rating, 
    y = after_stat(count / tapply(count, group, sum)[group]),
    colour = who, 
    fill = who
  )
) +
  annotation_raster(
    raster = matrix(rep(viridis_pal(option = "plasma", alpha = 0.10)(50), each = 50), nrow = 50),
    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf
  ) +
  geom_bar(
    position = position_dodge2(width = 0.90, preserve = "single"),
    na.rm = TRUE,
    colour = NA
  ) +
  geom_text(
    mapping = aes(label = after_stat(percent(count / tapply(count, group, sum)[group], suffix = " %", accuracy = 0.1))),
    stat = "count",
    position = position_dodge2(width = 0.90, preserve = "single"),
    family = "xkcd",
    angle = 90,
    size = 3,
    hjust = -0.1,
    vjust = 0.5,
    na.rm = TRUE,
    show.legend = FALSE
  ) +
  scale_x_binned(
    limits = c(0, 10),
    right = FALSE,
    labels = function(x) ifelse(x %in% 10, x, paste0(x, "+")),
    expand = c(0, 0)
  ) +
  scale_y_continuous(labels = percent_format(suffix = " %"), expand = expansion(c(0, 0.15))) +
  scale_colour_manual(values = unname(who_colours), labels = names(who_colours)) +
  scale_fill_manual(values = unname(who_colours), labels = names(who_colours)) +
  labs(
    x = "Rating", 
    y = "Percentage of Movies", 
    colour = NULL,
    fill = NULL,
    title = glue(
      'Distribution of Ratings ({glue_collapse(range(ratings_ms[["year_rated"]]), sep = "--")}; N = {comma(n_distinct(ratings_ms[["const"]]))})'
    ),
    subtitle = text_legend,
    caption = fig_caption
  ) +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank()
  )

if (params[["static"]]) {
  print(p_ratings + aes(group = who))
} else {
  animate(
    plot = p_ratings + 
      aes(group = paste(who, year_rated, sep = "_")) +
      labs(
        title = 'Distribution of Ratings ({comma(nrow(drop_na(select(filter(ratings_ms, year_rated == closest_state), ends_with("rating")))))}) in {closest_state}',
        subtitle = "{text_legend}"
      ) +
      transition_states(year_rated, transition_length = 3, state_length = 6) +
      enter_fade() +
      exit_fade(),
    width = 6.3 * 2.54,
    height = 4.7 * 2.54,
    units = "cm",
    res = 120,
    bg = theme_get()$plot.background$colour,
    renderer = gifski_renderer()
  )
}
```
