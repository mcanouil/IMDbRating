---
title: "IMDb Ratings Analysis"
author: "MickaÃ«l Canouil"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
monofont: "Source Code Pro"
monofontoptions: "Scale=0.7"
params:
  outputCode: FALSE
  nCores: !r parallel::detectCores()
  theme_dark: TRUE
  dpi: 120
  ggFontSize: 9
output:
  bookdown::html_document2:
    theme: simplex
    toc: true
    toc_depth: 2
    toc_float: 
      collapsed: false
    fig_width: 5
    fig_height: 3.5
    number_sections: false
    self_contained: true
    mathjax: default
    df_print: kable
---

```{r setup, include = FALSE, echo = FALSE}
options(stringsAsFactors = FALSE)
# Sys.setlocale("LC_TIME", "English")


library(knitr)
opts_chunk$set(
  size = "small",
  include = TRUE, # params$outputCode,
  echo = params$outputCode,
  warning = params$outputCode,
  message = params$outputCode,
  tidy = FALSE,
  crop = TRUE,
  autodep = TRUE,
  fig.align = "center",
  fig.pos = "H",
  dpi = params$dpi,
  fig.path = "./images/"
)

library(kableExtra)
library(Hmisc)


### Define nCores
nCores <- params$nCores


### Load packages
library(readxl)
library(writexl)
library(broom)
library(grid)
library(scales)
library(cowplot)
library(ggrepel)
library(viridis)
library(lubridate)
library(gridExtra)
library(ggpubr)
invisible(sapply(list.files("../DEV/Rfunctions/", full.names = TRUE), source))
library(tidyverse)

theme_dark <- params$theme_dark
if (theme_dark) {
  theme_set(theme_black(base_size = params$ggFontSize))
  plot_grid <- hijack(plot_grid, theme_dark = theme_dark)
  scale_colour_viridis <- hijack(
    scale_colour_viridis,
    option = "viridis",
    begin = 2 / 5,
    end = 1,
    direction = -1
  )
  scale_fill_viridis <- hijack(
    scale_fill_viridis,
    option = "viridis",
    begin = 2 / 5,
    end = 1,
    direction = -1
  )
} else {
  theme_set(theme_light(base_size = params$ggFontSize))
  scale_colour_viridis <- hijack(
    scale_colour_viridis,
    option = "viridis",
    begin = 0,
    end = 4 / 5
  )
  scale_fill_viridis <- hijack(
    scale_fill_viridis,
    option = "viridis",
    begin = 0,
    end = 4 / 5
  )
}
```

```{r read_imdb, include = FALSE}
bestStreak <- function(vec) {
  max(subset(as.data.frame(unclass(rle(vec))), values, lengths))
}

# "http://www.imdb.com/user/ur56341222/ratings?start=1&view=compact"

ratings <- read_csv("ratings.csv") %>%
  mutate(
    YearRated = year(`Date Rated`),
    Genres = map(Genres, simpleCap) %>% 
      gsub("Musical", "Music", .)
  )

ratings_agg <- ratings %>%
  group_by(`Date Rated`) %>%
  summarise(
    avg_rating = mean(`Your Rating`),
    n_rating = n()
  ) %>%
  right_join(
    tibble(
      "Date Rated" = seq(
        from = as.Date("2014-01-01"),
        to = as.Date(paste0(year(Sys.Date()), "-12-31")),
        by = 1
      )
    )
  ) %>%
  mutate(
    YearRated = year(`Date Rated`),
    Month = month(`Date Rated`, label = TRUE, abbr = FALSE),
    Day = day(`Date Rated`),
    wDay = wday(`Date Rated`, label = TRUE, abbr = FALSE, week_start = 1),
    wDay = factor(wDay, levels = rev(levels(wDay))),
    n_rating = ifelse(is.na(n_rating), 0, n_rating),
    Week = isoweek(`Date Rated`)
  ) %>%
  group_by(YearRated) %>%
  mutate(
    streak = paste0(
      "Movies rated: ", sum(n_rating), "\n",
      "Best streak: ", bestStreak(n_rating != 0), " days ! ",
      "Worst streak: ", bestStreak(n_rating == 0), " days !"
    ),
    Week = ifelse(Month=="January" & Week>=50, 0, Week),
    Week = ifelse(Month=="December" & Week<=40, max(Week)+1, Week) 
  ) %>%
  ungroup()
```

# Movies Streak {.tabset}
```{r movies_streak, fig.height = 2, results = "asis"}
p_movies_streak <- lapply(unique(ratings_agg[["YearRated"]]), function(iyear) {
  ratings_agg_year <- ratings_agg %>% 
    filter(YearRated == iyear)
  
  x_labels <- ratings_agg_year %>% 
    select(Week, Month) %>% 
    distinct() %>% 
    group_by(Month) %>% 
    summarise(Week = min(Week)+2)

  p <- ratings_agg_year %>% 
    ggplot(aes(x = Week, y = wDay, fill = avg_rating, label = n_rating)) +
      geom_tile(colour = "grey20", size = 0.1) +
      geom_text(colour = "white", fontface = "bold", size = 1.5) +
      scale_fill_viridis(name = "Average\nRating", limits = c(0, 10), na.value = "grey30") +
      scale_y_discrete(expand = c(0, 0)) +
      scale_x_continuous(
        expand = c(0, 0), 
        breaks = x_labels[["Week"]], 
        labels = x_labels[["Month"]]
      ) +
      theme(
        axis.ticks = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_blank(),
        panel.grid = element_blank()
      ) +
      labs(title = "Movies streak", x = "Month", y = "Day") +
    facet_grid(~streak)
  return(p)
}) %>% 
  `names<-`(as.character(unique(ratings_agg[["YearRated"]])))

for (iyear in as.character(unique(ratings_agg[["YearRated"]]))) {
  cat("\n##", iyear, "{-}\n")
  print(p_movies_streak[[iyear]])
  cat("\n")
}
```

# Genres distribution {.tabset}
```{r genres_distribution, results = "asis"}
p_genres_distribution <- lapply(unique(ratings[["YearRated"]]), function(iyear) {
  ratings %>% 
    filter(YearRated==iyear) %>% 
    mutate(
      Genre_details = map(Genres, function(x) {
        tibble(
          Genre = unique(unlist(strsplit(x, split = ", "))),
          Weight = 1 / length(Genre)
        )
      })
    ) %>% 
    unnest(Genre_details) %>% 
    group_by(Genre) %>% 
    summarise(Score = sum(Weight)) %>% 
    arrange(desc(Score)) %>% 
    filter(Genre!="NANA") %>% 
    mutate(
      Genre = factor(Genre, levels = unique(Genre))
    ) %>% 
    ggplot(aes(x = factor(1), y = Score, fill = Genre)) +
      geom_bar(colour = "white", width = 1, stat = "identity") +
      coord_polar(theta = "y") +
      scale_fill_viridis(discrete = TRUE, guide = guide_legend(ncol = 2)) +
      labs(title = "Genres distribution") +
      theme(
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_blank(), 
        legend.text = element_text(size = rel(0.4))
      )
}) %>% 
  `names<-`(as.character(unique(ratings[["YearRated"]])))

for (iyear in as.character(unique(ratings[["YearRated"]]))) {
  cat("\n##", iyear, "{-}\n")
  print(ggdraw(plot = p_genres_distribution[[iyear]], theme_dark = theme_dark))
  cat("\n")
}
```

# Rating per Genre {.tabset}
```{r genres_rating, results = "asis"}
p_genres_rating <- lapply(unique(ratings[["YearRated"]]), function(iyear) {
  ratings %>% 
    filter(YearRated==iyear) %>% 
    mutate(
      Genre_details = map(Genres, function(x) {
        tibble(
          Genre = unique(unlist(strsplit(x, split = ", "))),
          Weight = 1 / length(Genre)
        )
      })
    ) %>% 
    unnest(Genre_details) %>% 
    group_by(Genre) %>% 
    summarise(
      Score = sum(Weight),
      Rating = (Weight %*% `Your Rating`) / Score,
      Rating_avg = mean(`Your Rating`),
      N = n()
    ) %>% 
    mutate(
      Per = N / sum(N)
    ) %>% 
    arrange(desc(Rating)) %>% 
    filter(Genre!="NANA") %>% 
    mutate(
      Genre = factor(Genre, levels = unique(Genre))
    ) %>% 
    ggplot(aes(x = Genre, y = Rating, fill = N)) +
      geom_bar(width = 1, stat = "identity", colour = "white") +
      geom_text(aes(label = N), colour = "black", nudge_y = -0.5, size = 1.5) +
      geom_text(aes(label = round(Rating, digits = 1)), colour = "white", nudge_y = 0.5, size = 2.5) +
      scale_fill_viridis(discrete = FALSE, direction = 1) +
      scale_x_discrete(expand = c(0, 0)) +
      scale_y_continuous(expand = c(0, 0), limits = c(0, 10), breaks = seq(0, 10, 2)) +
      # geom_vline(aes(xintercept = min(which(Per < median(Per))) - 0.5), colour = "white", linetype = 2) +
      labs(title = "Average Weighted Rating per Genre") +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.x = element_blank(),
        panel.grid.major.x = element_blank()
      )
}) %>% 
  `names<-`(as.character(unique(ratings[["YearRated"]])))

for (iyear in as.character(unique(ratings[["YearRated"]]))) {
  cat("\n##", iyear, "{-}\n")
  print(ggdraw(plot = p_genres_rating[[iyear]], theme_dark = theme_dark))
  cat("\n")
}
```

# Runtime versus Ratings {.tabset}
```{r ratings_runtime, results = "asis"}
p_ratings_runtime <- lapply(unique(ratings[["YearRated"]]), function(iyear) {
  ratings %>% 
    filter(YearRated==iyear) %>%
    select(`Your Rating`, `Runtime (mins)`) %>%
    group_by(`Your Rating`) %>%
    summarise(Runtime = sum(`Runtime (mins)`, na.rm = TRUE) / (60 * 24)) %>%
    ggplot(aes(x = factor(1), y = Runtime, fill = factor(`Your Rating`))) +
      geom_bar(colour = "white", width = 1, stat = "identity") +
      geom_label_repel(
        aes(
          x = 1.5,
          y = cumsum(rev(Runtime)) - rev(Runtime) / 2,
          label = round(rev(Runtime), digits = 1)
        ), 
        fill = "white", 
        size = 3, 
        nudge_x = 0.25,
        min.segment.length = 0, 
        segment.colour = "white"
      ) +
      coord_polar(theta = "y") +
      scale_fill_viridis(name = "Rating", discrete = TRUE) +
      labs(title = "Days Spent Watching Movies per Rating") +
      theme(
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_blank()
      )
}) %>% 
  `names<-`(as.character(unique(ratings[["YearRated"]])))

for (iyear in as.character(unique(ratings[["YearRated"]]))) {
  cat("\n##", iyear, "{-}\n")
  print(ggdraw(plot = p_ratings_runtime[[iyear]], theme_dark = theme_dark))
  cat("\n")
}
```

# Rating distribution {.tabset}
```{r FifthPlot, results = "asis"}
p_ratings_distribution <- lapply(unique(ratings[["YearRated"]]), function(iyear) {
  ratings %>% 
    filter(YearRated==iyear) %>% 
    select(`Your Rating`, `IMDb Rating`) %>%
    gather(key = Who, value = Rating) %>%
    ggplot(aes(x = round(Rating, digits = 0), fill = Who)) +
      geom_density(
        aes(y = ..count.. / sum(..count..) * 100), 
        bw = 2, 
        alpha = 0.75, 
        colour = "white"
      ) +
      geom_bar(
        aes(y = ..count.. / sum(..count..)), 
        width = 0.90, 
        colour = "white", 
        position = position_dodge(preserve = "single")
      ) +
      scale_x_continuous(name = "Rating", limits = c(0, 10), breaks = seq(0, 10, 2)) +
      scale_y_continuous(labels = percent) +
      scale_fill_viridis(discrete = TRUE) +
      labs(x = "Rating", y = "Proportion", title = "Distribution of Ratings") +
      theme(legend.position = c(0, 1), legend.justification = c(-0.05, 1.05))
}) %>% 
  `names<-`(as.character(unique(ratings[["YearRated"]])))

for (iyear in as.character(unique(ratings[["YearRated"]]))) {
  cat("\n##", iyear, "{-}\n")
  print(ggdraw(plot = p_ratings_distribution[[iyear]], theme_dark = theme_dark))
  cat("\n")
}
```

# Final
```{r Coeos_IMDb, fig.height = 4*4, fig.width = 5*2, eval = FALSE}
pTop <- ratings %>%
  arrange(desc(Your.Rating), desc(IMDb.Rating)) %>%
  select(Title, Your.Rating, IMDb.Rating) %>%
  head() %>%
  ggtexttable(., rows = NULL, theme = ttheme("mBlack")) %>%
  ggdraw(., theme_dark = theme_dark) %>%
  gridExtra::arrangeGrob(., top = text_grob("Best Movies", color = "white", face = "bold", size = 12)) %>%
  as_ggplot() %>%
  ggdraw(., theme_dark = theme_dark)

pBad <- ratings %>%
  arrange(Your.Rating, IMDb.Rating) %>%
  select(Title, Your.Rating, IMDb.Rating) %>%
  head() %>%
  ggtexttable(., rows = NULL, theme = ttheme("mBlack")) %>%
  ggdraw(., theme_dark = theme_dark) %>%
  gridExtra::arrangeGrob(., top = text_grob("Worst Movies", color = "white", face = "bold", size = 12)) %>%
  as_ggplot() %>%
  ggdraw(., theme_dark = theme_dark)


p <- ggarrange(
  pFirst,
  ggarrange(pTop, pBad, ncol = 2),
  pThird,
  ggarrange(ggdraw(pFourth, theme_dark = theme_dark), pFifth, ncol = 2),
  nrow = 4,
  heights = c(0.75, 0.5, 1, 1),
  widths = rep(0.9, 4)
) %>%
  gridExtra::arrangeGrob(., top = text_grob(paste0(myYear, " in Movie Theatres"), color = "white", face = "bold", size = 16)) %>%
  as_ggplot() %>%
  ggdraw(., theme_dark = theme_dark)

print(p)
ggsave(file = paste0("Coeos_IMDb_", myYear, ".png"), plot = p, width = 10, height = 16, units = "in", dpi = 300)
```
