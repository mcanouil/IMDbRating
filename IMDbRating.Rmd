---
title: "My IMDb Ratings Analysis"
params:
  output_code: FALSE
  n_cores: !r parallel::detectCores()
  theme_dark: TRUE
  dpi: 150
  gg_fontsize: 9
output:
  html_document:
    theme: simplex
    fig_width: 5
    fig_height: 3.5
    self_contained: true
    keep_md: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, echo = FALSE}
options(stringsAsFactors = FALSE)

knitr::opts_chunk$set(
  results = "asis",
  size = "small",
  include = TRUE, # params$output_code,
  echo = params$output_code,
  warning = params$output_code,
  message = params$output_code,
  tidy = FALSE,
  crop = TRUE,
  autodep = TRUE,
  fig.align = "center",
  fig.pos = "h",
  dpi = params$dpi,
  fig.path = "./images/"
)


### Define
n_cores <- params$n_cores

### Load packages
library(tidyverse)
library(viridis)
library(scales)
library(lubridate)
library(grid)
library(gridExtra)
library(ggrepel)
library(ggpubr)
library(rvest)
library(gganimate)

devtools::source_url('https://github.com/mcanouil/DEV/raw/master/R/theme_black.R')
devtools::source_url('https://github.com/mcanouil/DEV/raw/master/R/capitalise.R')

### functions
source("./R/set_colours.R")
source("./R/best_streak.R")
source("./R/get_metascore.R")
source("./R/add_metascore.R")
source("./R/plot_streak.R")
source("./R/plot_genres_distribution.R")
source("./R/plot_genres_rating.R")
source("./R/plot_ratings_runtime.R")
source("./R/plot_ratings_distribution.R")
source("./R/plot_bad.R")
source("./R/plot_top.R")
source("./R/plot_movies_theatres.R")
source("./R/print_infography.R")

### ggplot2 parameters
if (params$theme_dark) {
  theme_set(theme_black(base_size = params$gg_fontsize))
} else {
  theme_set(theme_grey(base_size = params$gg_fontsize))
}
```

```{r movies_data, incude = FALSE}
movies_theatres <- source('./data/movies_theatres.R')$value
```

```{r read_imdb, include = FALSE}
# "http://www.imdb.com/user/ur56341222/ratings?start=1&view=compact"
ratings <- add_metascore(
  file_in = "./data/ratings.csv", 
  file_out = "./data/ratings_ms.csv", 
  from = 2016, 
  locale = locale(encoding = "Windows-1252")
)
```

# Infography {.tabset}
```{r ggplot_time, fig.height = 9, fig.width = 16}
### make plots
gg_ratings <- ratings %>% 
  mutate(YR = YearRated) %>% 
  group_by(YR) %>% 
  nest() %>% 
  mutate(
    p_movies_streak = map(.x = data, .f = plot_streak),
    p_genres_distribution = map(.x = data, .f = plot_genres_distribution),
    p_genres_rating = map(.x = data, .f = plot_genres_rating),
    p_ratings_runtime = map(.x = data, .f = plot_ratings_runtime),
    p_ratings_distribution = map(.x = data, .f = plot_ratings_distribution),
    p_bad = map(.x = data, .f = plot_bad),
    p_top = map(.x = data, .f = plot_top)
  ) %>% 
  mutate(
    data_agg = list(movies_theatres),
    p_movies_theatres = map2(.x = YR, .y = data_agg, .f = plot_movies_theatres)
  ) %>% 
  select(-data, -data_agg) %>%
  ungroup()

p <- gg_ratings %>% 
  group_by(YR) %>% 
  mutate(
    gg = map(
      .x = YR,
      .a = p_movies_streak,
      .b = p_movies_theatres,
      .c = p_top,
      .d = p_bad,
      .e = p_genres_rating,
      .g = p_ratings_runtime,
      .h = p_genres_distribution,
      .i = p_ratings_distribution,
      .f = print_infography
    ) %>% 
      map2(.x = YR, .y = ., .f = function(x, y) {
        ggsave(
          filename = paste0("./images/", x, "_Coeos_IMDb.png"),
          plot = y,
          width = 16,
          height = 9,
          dpi = 300
        )
        cat("\n\n")
        cat("##", YR, "  \n\n")
        print(y)
        cat("\n\n")
        return(y)
      })
  ) %>% 
  ungroup()
```

# GIF {.tabset}
## Movies at theatre (smooth)
```{r gif_circular}
data_radar <- movies_theatres  %>% 
  mutate(
    Year = as.character(Year),
    Month = factor(Month, levels = locale()$date_names$mon)
  ) %>% 
  bind_rows(
    movies_theatres  %>% 
      mutate(
        Year = as.character(Year),
        Month = factor(Month, levels = locale()$date_names$mon)
      ) %>% 
      group_by(Month) %>% 
      summarise(
        Year = "ALL",
        Count = floor(mean(Count, na.rm = TRUE))
      )
  ) %>% 
  arrange(Year, Month) %>%
  mutate(
    YM = paste0(Year, sprintf("%02d", as.numeric(Month))) %>% factor() %>% as.integer(),
    Year = factor(x = Year, levels = c(2013:2018, "ALL")),
    Month_int = as.integer(Month)
  )

p <- ggplot(data = data_radar) +
  # theme
  theme_black(base_size = 16) +
  geom_hline(
    yintercept = seq(0, 20, by = 2.5), 
    colour = ggplot2::theme_get()$panel.grid$colour, 
    size = 0.2
  ) +
  geom_hline(
    yintercept = seq(0, 20, by = 5), 
    colour = ggplot2::theme_get()$panel.grid$colour, 
    size = 0.4
  ) +
  geom_rect(
    fill = ggplot2::theme_get()$plot.background$colour, 
    xmin = 1, 
    xmax = 0, 
    ymin = 0, 
    ymax = 20, 
    inherit.aes = FALSE
  ) +
  geom_hline(
    yintercept = 20, 
    colour = ggplot2::theme_get()$panel.grid$colour, 
    size = 0.4
  ) +
  geom_vline(
    xintercept = seq_len(12), 
    colour = ggplot2::theme_get()$panel.grid$colour, 
    size = 0.2
  ) +
  geom_text(
    data = tibble(
      Count = c(0, rep(seq(5, 20, by = 5), times = 4)), 
      Month = c(1, rep(c(1, 4, 7, 10), each = 4))
    ),
    mapping = aes(x = Month, y = Count, label = Count),
    colour = ggplot2::theme_get()$text$colour,
    size = 16 * 1/5,
    inherit.aes = FALSE
  ) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1))) +
  scale_x_continuous(
    limits = c(0, 12), 
    breaks = seq_len(12), 
    labels = locale()$date_names$mon
  ) +
  coord_polar(theta = "x", start = 2 * pi * 11/12) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = rel(0.80)),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank()
  ) +
  # real geom
  geom_smooth(
    aes(x = Month_int, y = Count, colour = "SMOOTH"),
    method = "loess",
    se = FALSE,
    size = 1,
    linetype = 2,
    show.legend = TRUE
  ) +
  scale_colour_manual(
    name = "Year",
    breaks = names(set_colours(data_radar[["Year"]], direction = 1)),
    values = set_colours(data_radar[["Year"]], direction = 1)
  ) +
  scale_fill_manual(
    name = "Year",
    breaks = names(set_colours(data_radar[["Year"]], direction = 1)),
    values = set_colours(data_radar[["Year"]], direction = 1)
  ) +
  geom_point(
    mapping = aes(x = Month_int, y = Count, colour = Year, fill = Year), 
    size = 3, shape = 21
  ) +
  geom_path(
    mapping = aes(x = Month_int, y = Count, colour = Year), 
    size = 1.5
  ) +
  guides(colour = "none", fill = "none") + 
  transition_states(
    Year,
    transition_length = 6,
    state_length = 8
  ) +
  enter_appear(early = TRUE) +
  exit_disappear(early = TRUE) +
  ease_aes('linear') +
  labs(title = "# Movies Seen in Theatres: {closest_state}") +
  labs(caption = "© Mickaël 'Coeos' Canouil") +
  theme(plot.caption = element_text(size = 8))


animate(
  plot = p, 
  width = 500, 
  height = 500, 
  units = "px", 
  bg = ggplot2::theme_get()$plot.background$colour,
  renderer = gifski_renderer(
    file = "./images/Coeos_IMDb_01.gif"
  )
)
```

## Movies at theatre (radar)
```{r gif_radar}
range_dates <- 2013:2018
p <- movies_theatres %>% 
  (function(.movies_theatres) {
    .movies_theatres  %>% 
      mutate(
        Year = as.character(Year),
        Month = factor(Month, levels = locale()$date_names$mon)
      ) %>% 
      bind_rows(
        .movies_theatres  %>% 
          mutate(
            Year = as.character(Year),
            Month = factor(Month, levels = locale()$date_names$mon)
          ) %>% 
          group_by(Month) %>% 
          summarise(
            Year = "ALL",
            Count = floor(mean(Count, na.rm = TRUE))
          )
      ) %>% 
      arrange(Year, Month) %>%
      mutate(
        YM = paste0(Year, sprintf("%02d", as.numeric(Month))) %>% factor() %>% as.integer(),
        Year = factor(x = Year, levels = c(range_dates, "ALL")),
        Month_int = as.integer(Month)
      )
  })(.) %>% 
  ggplot(data = ., mapping = aes(group = Year)) +
  coord_polar(theta = "x") +
  # theme
  theme_black(base_size = 16) +
    theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(size = rel(0.75)),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    panel.grid = element_blank(), # panel.grid.minor.x
    panel.border = element_blank(),
    plot.caption = element_text(size = 8, hjust = 0.5)
  ) +
  scale_y_continuous(
    limits = c(0, 22.5),
    breaks = seq(0, 20, by = 5),
    minor_breaks = seq(0, 20, by = 2.5),
    expand = c(0, 0)
  ) +
  scale_x_continuous(
    breaks = seq_len(12),
    labels = locale()$date_names$mon,
    expand = c(0, 0)
  ) +
  scale_colour_manual(
    name = "Year",
    values = c("white", viridis_pal(direction = 1)(length(range_dates))) %>% 
      `names<-`(c("ALL", range_dates))
  ) +
  scale_fill_manual(
    name = "Year",
    values = c("white", viridis_pal(direction = 1)(length(range_dates))) %>% 
      `names<-`(c("ALL", range_dates))
  ) +
  scale_size_manual(
    name = "Year",
    values = c(5, rep(3, length(range_dates))) %>% 
      `names<-`(c("ALL", range_dates))
  ) +
  geom_hline( # layer 1
    yintercept = seq(0, 20, by = 2.5),
    colour = ggplot2::theme_get()$panel.grid$colour,
    size = 0.2
  ) +
  geom_hline( # layer 2
    yintercept = seq(0, 20, by = 5),
    colour = ggplot2::theme_get()$panel.grid$colour,
    size = 0.4
  ) +
  geom_hline( # layer 3
    yintercept = 20,
    colour = ggplot2::theme_get()$panel.grid$colour,
    size = 0.4
  ) +
  geom_vline( # layer 4
    xintercept = seq_len(12),
    colour = ggplot2::theme_get()$panel.grid$colour,
    size = 0.2
  ) +
  geom_text( # layer 5
    data = tibble(
      Count = c(0, rep(seq(5, 20, by = 5), times = 3)),
      Month = c(1, rep(c(1, 5, 8), each = 4))
    ),
    mapping = aes(x = Month, y = Count, label = Count),
    colour = ggplot2::theme_get()$text$colour,
    size = 16 * 1/4,
    inherit.aes = FALSE
  ) +
  geom_vline( # layer 6
    mapping = aes(xintercept = Month_int),
    colour = "grey50"
  ) +
  geom_point( # layer 7
    mapping = aes(x = Month_int, y = Count, colour = Year, size = Year)
  ) +
  geom_path( # layer 8
    mapping = aes(x = Month_int, y = Count, colour = Year),
    size = 1.5
  ) +
  labs(
    title = "# Movies Seen in Theatres",
    caption = "© Mickaël 'Coeos' Canouil"
  )


animate(
  plot = p + 
    transition_reveal(id = Year, along = Month_int, range = c(1L, 12L), keep_last = TRUE) +
    shadow_wake(
      wake_length = 0.15,
      wrap = TRUE,
      exclude_layer = c(1:5, 7, 8),
      exclude_phase = NULL
    ), 
  width = 500, 
  height = 500, 
  units = "px", 
  bg = ggplot2::theme_get()$plot.background$colour,
  renderer = gifski_renderer(
    file = "./images/Coeos_IMDb_02.gif"
  )
)

```

## Ratings distribution
```{r gif_distribution}
data_ratings <- full_join(
  x = ratings %>% 
    select(ends_with("Rating"), YearRated) %>%
    gather(key = Who, value = Rating, -YearRated) %>%
    mutate(
      Who = Who %>% gsub(" Rating", "", .) %>% gsub("Your", "User", .),
      rounded_rating = round(Rating, digits = 0)
    ) %>% 
    select(-Rating) %>% 
    group_by(YearRated, Who, rounded_rating) %>% 
    summarise(n = n()) %>% 
    mutate(rating = factor(x = rounded_rating, levels = 1:10)) %>% 
    complete(rating) %>% 
    mutate(
      rounded_rating = ifelse(is.na(rounded_rating), as.numeric(rating), rounded_rating),
      n = ifelse(is.na(n), 0, n)
    ) %>% 
    ungroup() %>% 
    group_by(YearRated, Who) %>% 
    mutate(
      total = sum(n),
      ntotal = n/total
    ) %>% 
    ungroup() %>% 
    select(YearRated, Who, rounded_rating, ntotal),
  y = ratings %>% 
    select(ends_with("Rating"), YearRated) %>%
    gather(key = Who, value = Rating, -YearRated) %>%
    mutate(
      Who = Who %>% gsub(" Rating", "", .) %>% gsub("Your", "User", .),
      rounded_rating = round(Rating, digits = 0)
    ) %>% 
    select(-Rating),
  by = c("YearRated", "Who", "rounded_rating")
) %>% 
  mutate(
    YearRated = as.character(YearRated)
  ) %>% 
  bind_rows(
    full_join(
      x = ratings %>% 
        select(ends_with("Rating"), YearRated) %>%
        gather(key = Who, value = Rating, -YearRated) %>%
        mutate(
          Who = Who %>% gsub(" Rating", "", .) %>% gsub("Your", "User", .),
          rounded_rating = round(Rating, digits = 0)
        ) %>% 
        select(-Rating) %>% 
        group_by(Who, rounded_rating) %>% 
        summarise(n = n()) %>% 
        mutate(rating = factor(x = rounded_rating, levels = 1:10)) %>% 
        complete(rating) %>% 
        mutate(
          rounded_rating = ifelse(is.na(rounded_rating), as.numeric(rating), rounded_rating),
          n = ifelse(is.na(n), 0, n)
        ) %>% 
        ungroup() %>% 
        group_by(Who) %>% 
        mutate(
          total = sum(n),
          ntotal = n/total
        ) %>% 
        ungroup() %>% 
        mutate(YearRated = "ALL") %>% 
        select(YearRated, Who, rounded_rating, ntotal),
      y = ratings %>% 
        select(ends_with("Rating"), YearRated) %>%
        gather(key = Who, value = Rating, -YearRated) %>%
        mutate(
          Who = Who %>% gsub(" Rating", "", .) %>% gsub("Your", "User", .),
          rounded_rating = round(Rating, digits = 0)
        ) %>% 
        select(-Rating) %>% 
        mutate(YearRated = "ALL"),
      by = c("YearRated", "Who", "rounded_rating")
    )
  )


p <- ggplot(data = data_ratings, aes(x = rounded_rating, fill = Who)) +
  theme_black(base_size = 16) +
  geom_density(colour = "white", adjust = 2.5, alpha = 0.25) +
  geom_histogram(
    data = distinct(data_ratings),
    mapping = aes(y = ntotal),
    stat = "identity",
    colour = "white",
    width = 0.5,
    position = position_dodge()
  ) +
  scale_x_continuous(
    expand = c(0, 0), 
    name = "Rating", 
    limits = c(0, 10), 
    breaks = c(0, seq_len(10))
  ) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), labels = percent) +
  scale_fill_viridis_d() +
  labs(
    x = "Rating", 
    y = "Proportion", 
    title = "Distribution of Ratings", 
    fill = "Rating from"
  ) + # facet_wrap(~YearRated)
  transition_states(
    YearRated,
    transition_length = 6,
    state_length = 8
  ) +
  enter_appear(early = TRUE) +
  exit_disappear(early = TRUE) +
  ease_aes('linear') +
  labs(
    title = "Distribution of Ratings: {closest_state}",
    caption = "© Mickaël 'Coeos' Canouil"
  ) +
  theme(
    plot.caption = element_text(size = 8),
    legend.position = c(1, 1),
    legend.justification = c(1.05, 1.05)
  )

animate(
  plot = p, 
  width = 800, 
  height = 450, 
  units = "px", 
  bg = ggplot2::theme_get()$plot.background$colour,
  renderer = gifski_renderer(
    file = "./images/Coeos_IMDb_03.gif"
  )
)
```

