---
title: "My IMDb Ratings Analysis"
params:
  output_code: FALSE
  n_cores: !r parallel::detectCores()
  theme_dark: TRUE
  dpi: 150
  gg_fontsize: 9
output:
  html_document:
    theme: simplex
    fig_width: 5
    fig_height: 3.5
    self_contained: true
    keep_md: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, echo = FALSE}
options(stringsAsFactors = FALSE)

knitr::opts_chunk$set(
  results = "asis",
  size = "small",
  include = TRUE, # params$output_code,
  echo = params$output_code,
  warning = params$output_code,
  message = params$output_code,
  tidy = FALSE,
  crop = TRUE,
  autodep = TRUE,
  fig.align = "center",
  fig.pos = "h",
  dpi = params$dpi,
  fig.path = "./images/"
)


### Define
n_cores <- params$n_cores

### Load packages
library(tidyverse)
library(viridis)
library(scales)
library(lubridate)
library(grid)
library(gridExtra)
library(ggrepel)
library(ggpubr)
library(rvest)
library(gganimate)

# devtools::source_url('https://github.com/mcanouil/DEV/raw/master/R/theme_black.R')
# devtools::source_url('https://github.com/mcanouil/DEV/raw/master/R/capitalise.R')

source('../DEV/R/theme_black.R')
source('../DEV/R/capitalise.R')

### functions
source("./R/set_colours.R")
source("./R/best_streak.R")
source("./R/get_metascore.R")
source("./R/add_metascore.R")
source("./R/plot_streak.R")
source("./R/plot_genres_distribution.R")
source("./R/plot_genres_rating.R")
source("./R/plot_ratings_runtime.R")
source("./R/plot_ratings_distribution.R")
source("./R/plot_bad.R")
source("./R/plot_top.R")
source("./R/plot_movies_theatres.R")
source("./R/print_infography.R")

### ggplot2 parameters
if (params$theme_dark) {
  theme_set(theme_black(base_size = params$gg_fontsize))
} else {
  ggplot2::theme_set(ggplot2::theme_grey(base_size = params$gg_fontsize))
}
```

```{r movies_data, incude = FALSE}
movies_theatres <- source('./data/movies_theatres.R')$value
```

```{r read_imdb, include = FALSE}
# "http://www.imdb.com/user/ur56341222/ratings?start=1&view=compact"
ratings <- add_metascore(
  file_in = "./data/ratings.csv", 
  file_out = "./data/ratings_ms.csv", 
  from = min(movies_theatres[["Year"]]), 
  locale = readr::locale(encoding = "Windows-1252")
)
```

# Infography {.tabset}
```{r ggplot_time, fig.height = 9, fig.width = 16}
### make plots
gg_ratings <- ratings %>% 
  dplyr::mutate(YR = YearRated) %>% 
  dplyr::group_by(YR) %>% 
  tidyr::nest() %>% 
  dplyr::mutate(
    p_movies_streak = purrr::map(.x = data, .f = plot_streak),
    p_genres_distribution = purrr::map(.x = data, .f = plot_genres_distribution),
    p_genres_rating = purrr::map(.x = data, .f = plot_genres_rating),
    p_ratings_runtime = purrr::map(.x = data, .f = plot_ratings_runtime),
    p_ratings_distribution = purrr::map(.x = data, .f = plot_ratings_distribution),
    p_bad = purrr::map(.x = data, .f = plot_bad),
    p_top = purrr::map(.x = data, .f = plot_top)
  ) %>% 
  dplyr::mutate(
    data_agg = list(movies_theatres),
    p_movies_theatres = purrr::map2(.x = YR, .y = data_agg, .f = plot_movies_theatres)
  ) %>% 
  dplyr::select(-data, -data_agg) %>%
  dplyr::ungroup()

p <- gg_ratings %>% 
  dplyr::group_by(YR) %>% 
  dplyr::mutate(
    gg = purrr::map(
      .x = YR,
      .a = p_movies_streak,
      .b = p_movies_theatres,
      .c = p_top,
      .d = p_bad,
      .e = p_genres_rating,
      .g = p_ratings_runtime,
      .h = p_genres_distribution,
      .i = p_ratings_distribution,
      .f = print_infography
    ) %>% 
      purrr::map2(.x = YR, .y = ., .f = function(x, y) {
        ggsave(
          filename = paste0("./images/", x, "_Coeos_IMDb.png"),
          plot = y,
          width = 16,
          height = 9,
          dpi = 300
        )
        cat("\n\n")
        cat("##", YR, "  \n\n")
        print(y)
        cat("\n\n")
        return(y)
      })
  ) %>% 
  dplyr::ungroup()
```

# GIF {.tabset}
```{r data_radar}
range_dates <- 2013:2018
p <- movies_theatres %>% 
  dplyr::mutate(Month = purrr::map_if(.x = Month, .p = ~.x=="January", .f = ~c(.x, "JD"))) %>% 
  tidyr::unnest() %>% 
  (function(.movies_theatres) {
    .movies_theatres  %>% 
      dplyr::mutate(
        Year = as.character(Year),
        Month = factor(Month, levels = c(readr::locale()$date_names$mon, "JD"))
      ) %>% 
      dplyr::bind_rows(
        .movies_theatres  %>% 
          dplyr::mutate(
            Year = as.character(Year),
            Month = factor(Month, levels = c(readr::locale()$date_names$mon, "JD"))
          ) %>% 
          dplyr::group_by(Month) %>% 
          dplyr::summarise(
            Year = "ALL",
            Count = floor(mean(Count, na.rm = TRUE))
          )
      ) %>% 
      dplyr::arrange(Year, Month) %>%
      dplyr::mutate(
        YM = paste0(Year, sprintf("%02d", as.numeric(Month))) %>% factor() %>% as.integer(),
        Year = factor(x = Year, levels = c(range_dates, "ALL")),
        Month_int = as.integer(Month)
      )
  })(.) %>% 
  ggplot2::ggplot(mapping = ggplot2::aes(group = Year)) +
  ggplot2::coord_polar(theta = "x") +
  # theme
  theme_black(base_size = 16) +
    ggplot2::theme(
    axis.text.y = ggplot2::element_blank(),
    axis.text.x = ggplot2::element_text(size = ggplot2::rel(0.75)),
    axis.title = ggplot2::element_blank(),
    axis.ticks = ggplot2::element_blank(),
    axis.line = ggplot2::element_blank(),
    panel.grid = ggplot2::element_blank(), # panel.grid.minor.x
    panel.border = ggplot2::element_blank(),
    plot.caption = ggplot2::element_text(size = 10, hjust = 0.5)
  ) +
  ggplot2::scale_y_continuous(
    limits = c(0, 22.5),
    breaks = seq(0, 20, by = 5),
    minor_breaks = seq(0, 20, by = 2.5),
    expand = c(0, 0)
  ) +
  ggplot2::scale_x_continuous(
    breaks = seq_len(12),
    labels = readr::locale()$date_names$mon,
    expand = c(0, 0)
  ) +
  ggplot2::scale_colour_manual(
    name = "Year",
    values = c("white", viridis_pal(direction = 1)(length(range_dates))) %>% 
      `names<-`(c("ALL", range_dates))
  ) +
  ggplot2::scale_fill_manual(
    name = "Year",
    values = c("white", viridis_pal(direction = 1)(length(range_dates))) %>% 
      `names<-`(c("ALL", range_dates))
  ) +
  ggplot2::scale_size_manual(
    name = "Year",
    values = c(5, rep(3, length(range_dates))) %>% 
      `names<-`(c("ALL", range_dates))
  ) +
  ggplot2::geom_hline( # layer 1
    yintercept = seq(0, 20, by = 2.5),
    colour = ggplot2::theme_get()$panel.grid$colour,
    size = 0.2
  ) +
  ggplot2::geom_hline( # layer 2
    yintercept = seq(0, 20, by = 5),
    colour = ggplot2::theme_get()$panel.grid$colour,
    size = 0.4
  ) +
  ggplot2::geom_hline( # layer 3
    yintercept = 20,
    colour = ggplot2::theme_get()$panel.grid$colour,
    size = 0.4
  ) +
  ggplot2::geom_vline( # layer 4
    xintercept = seq_len(12),
    colour = ggplot2::theme_get()$panel.grid$colour,
    size = 0.2
  ) +
  ggplot2::geom_text( # layer 5
    data = dplyr::tibble(
      Count = c(0, rep(seq(5, 20, by = 5), times = 4)), 
      Month = c(1, rep(c(1, 4, 7, 10), each = 4))
    ),
    mapping = ggplot2::aes(x = Month, y = Count, label = Count),
    colour = ggplot2::theme_get()$text$colour,
    size = 16 * 1/4,
    inherit.aes = FALSE
  ) +
  ggplot2::geom_vline( # layer 6
    mapping = ggplot2::aes(xintercept = Month_int),
    colour = "grey50"
  ) +
  ggplot2::geom_point( # layer 7
    mapping = ggplot2::aes(x = Month_int, y = Count, colour = Year, size = Year)
  ) +
  ggplot2::geom_path( # layer 8
    mapping = ggplot2::aes(x = Month_int, y = Count, colour = Year),
    size = 1.5
  ) +
  ggplot2::labs(
    title = "# Movies Seen in Theatres",
    caption = "© Mickaël 'Coeos' Canouil"
  )
```

## Movies at theatre (smooth)
```{r gif_circular}
p_animate1 <- p +
  ggplot2::geom_smooth(
    mapping = ggplot2::aes(x = Month_int, y = Count),
    colour ="white",
    method = "loess",
    se = FALSE,
    size = 1,
    linetype = 2,
    show.legend = FALSE
  ) +
  gganimate::transition_states(
    Year,
    transition_length = 6,
    state_length = 8
  ) +
  gganimate::enter_appear(early = TRUE) +
  gganimate::exit_disappear(early = TRUE) +
  gganimate::ease_aes('linear') +
  ggplot2::labs(subtitle = "{closest_state}") +
  ggplot2::theme(legend.position = "none")

gganimate::animate(
  plot = p_animate1, 
  width = 500, 
  height = 500, 
  units = "px", 
  bg = ggplot2::theme_get()$plot.background$colour,
  renderer = gganimate::gifski_renderer(
    file = "./images/Coeos_IMDb_01.gif"
  )
)
```

## Movies at theatre (radar)
```{r gif_radar}
p_animate2 <- p + 
  gganimate::transition_reveal(along = Month_int, range = c(1L, 13L), keep_last = TRUE) +
  gganimate::shadow_wake(
    wake_length = 0.15,
    wrap = TRUE,
    exclude_layer = c(1:5, 7, 8),
    exclude_phase = NULL
  )

gganimate::animate(
  plot = p_animate2, 
  width = 500, 
  height = 500, 
  units = "px", 
  bg = ggplot2::theme_get()$plot.background$colour,
  renderer = gganimate::gifski_renderer(
    file = "./images/Coeos_IMDb_02.gif"
  )
)
```

## Ratings distribution
```{r gif_distribution}
data_ratings <- dplyr::full_join(
  x = ratings %>% 
    dplyr::select(dplyr::ends_with("Rating"), YearRated) %>%
    tidyr::gather(key = Who, value = Rating, -YearRated) %>%
    dplyr::mutate(
      Who = Who %>% gsub(" Rating", "", .) %>% gsub("Your", "User", .),
      rounded_rating = round(Rating, digits = 0)
    ) %>% 
    dplyr::select(-Rating) %>% 
    dplyr::group_by(YearRated, Who, rounded_rating) %>% 
    dplyr::summarise(n = dplyr::n()) %>% 
    dplyr::mutate(rating = factor(x = rounded_rating, levels = 1:10)) %>% 
    tidyr::complete(rating) %>% 
    dplyr::mutate(
      rounded_rating = ifelse(is.na(rounded_rating), as.numeric(rating), rounded_rating),
      n = ifelse(is.na(n), 0, n)
    ) %>% 
    dplyr::ungroup() %>% 
    dplyr::group_by(YearRated, Who) %>% 
    dplyr::mutate(
      total = sum(n),
      ntotal = n/total
    ) %>% 
    dplyr::ungroup() %>% 
    dplyr::select(YearRated, Who, rounded_rating, ntotal),
  y = ratings %>% 
    dplyr::select(dplyr::ends_with("Rating"), YearRated) %>%
    tidyr::gather(key = Who, value = Rating, -YearRated) %>%
    dplyr::mutate(
      Who = Who %>% gsub(" Rating", "", .) %>% gsub("Your", "User", .),
      rounded_rating = round(Rating, digits = 0)
    ) %>% 
    dplyr::select(-Rating),
  by = c("YearRated", "Who", "rounded_rating")
) %>% 
  dplyr::mutate(
    YearRated = as.character(YearRated)
  ) %>% 
  dplyr::bind_rows(
    dplyr::full_join(
      x = ratings %>% 
        dplyr::select(dplyr::ends_with("Rating"), YearRated) %>%
        tidyr::gather(key = Who, value = Rating, -YearRated) %>%
        dplyr::mutate(
          Who = Who %>% gsub(" Rating", "", .) %>% gsub("Your", "User", .),
          rounded_rating = round(Rating, digits = 0)
        ) %>% 
        dplyr::select(-Rating) %>% 
        dplyr::group_by(Who, rounded_rating) %>% 
        dplyr::summarise(n = dplyr::n()) %>% 
        dplyr::mutate(rating = factor(x = rounded_rating, levels = 1:10)) %>% 
        tidyr::complete(rating) %>% 
        dplyr::mutate(
          rounded_rating = ifelse(is.na(rounded_rating), as.numeric(rating), rounded_rating),
          n = ifelse(is.na(n), 0, n)
        ) %>% 
        dplyr::ungroup() %>% 
        dplyr::group_by(Who) %>% 
        dplyr::mutate(
          total = sum(n),
          ntotal = n/total
        ) %>% 
        dplyr::ungroup() %>% 
        dplyr::mutate(YearRated = "ALL") %>% 
        dplyr::select(YearRated, Who, rounded_rating, ntotal),
      y = ratings %>% 
        dplyr::select(dplyr::ends_with("Rating"), YearRated) %>%
        tidyr::gather(key = Who, value = Rating, -YearRated) %>%
        dplyr::mutate(
          Who = Who %>% gsub(" Rating", "", .) %>% gsub("Your", "User", .),
          rounded_rating = round(Rating, digits = 0)
        ) %>% 
        dplyr::select(-Rating) %>% 
        dplyr::mutate(YearRated = "ALL"),
      by = c("YearRated", "Who", "rounded_rating")
    )
  )


p <- ggplot2::ggplot(
  data = data_ratings, 
  mapping = ggplot2::aes(x = rounded_rating, fill = Who)
) +
  theme_black(base_size = 16) +
  ggplot2::geom_density(colour = "white", adjust = 2.5, alpha = 0.25, na.rm = TRUE) +
  ggplot2::geom_bar(
    data = dplyr::distinct(data_ratings),
    mapping = ggplot2::aes(y = ntotal),
    stat = "identity",
    colour = "white",
    width = 0.5,
    position = ggplot2::position_dodge(),
    na.rm = TRUE
  ) +
  ggplot2::scale_x_continuous(
    expand = c(0, 0), 
    name = "Rating", 
    limits = c(0, 10), 
    breaks = c(0, seq_len(10))
  ) +
  ggplot2::scale_y_continuous(
    expand = ggplot2::expand_scale(mult = c(0, 0.1)), 
    labels = scales::percent
  ) +
  scale_fill_viridis_d() +
  ggplot2::labs(
    x = "Rating", 
    y = "Proportion", 
    title = "Distribution of Ratings", 
    fill = "Rating from"
  ) + # facet_wrap(~YearRated)
  gganimate::transition_states(
    YearRated,
    transition_length = 6,
    state_length = 8
  ) +
  gganimate::enter_appear(early = TRUE) +
  gganimate::exit_disappear(early = TRUE) +
  gganimate::ease_aes('linear') +
  ggplot2::labs(
    title = "Distribution of Ratings: {closest_state}",
    caption = "© Mickaël 'Coeos' Canouil"
  ) +
  ggplot2::theme(
    plot.caption = ggplot2::element_text(size = 10),
    legend.position = c(1, 1),
    legend.justification = c(1.05, 1.05)
  )

gganimate::animate(
  plot = p, 
  width = 800, 
  height = 450, 
  units = "px", 
  bg = ggplot2::theme_get()$plot.background$colour,
  renderer = gganimate::gifski_renderer(
    file = "./images/Coeos_IMDb_03.gif"
  )
)
```

